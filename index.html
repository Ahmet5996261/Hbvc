<script>
(() => {
  // --- Sabitler ve Veriler ---

  const langData = {
    tr: {
      prayerTitle: "HBVC Namaz Vakitleri (Duisburg Hochfeld - 31 Mayıs 2025)",
      hadith: "Hz. Peygamber (s.a.v) buyurdu ki: <strong>“Kolaylaştırınız, zorlaştırmayınız; müjdeleyiniz, nefret ettirmeyiniz.”</strong> (Buhari)",
      countdownLabel: "Dua Vakitlerine Geri Sayım:",
      quizTitle: "Günün Quizi",
      countdownBtnShow: "Geri Sayımı Göster",
      countdownBtnHide: "Geri Sayımı Gizle",
      prayers: [
        {name: "İmsak", time: "03:15"},
        {name: "Güneş", time: "05:30"},
        {name: "Öğle", time: "13:00"},
        {name: "İkindi", time: "17:00"},
        {name: "Akşam", time: "20:15"},
        {name: "Yatsı", time: "22:00"}
      ],
      quiz: [
        {
          question: "Namaz kaç vakittir?",
          options: ["3", "5", "7", "4"],
          answer: 1
        },
        {
          question: "Kıble hangi yöne doğrudur?",
          options: ["Kuzey", "Güney", "Kıble", "Batı"],
          answer: 2
        },
        {
          question: "Oruç hangi ayda tutulur?",
          options: ["Ramazan", "Şevval", "Zilhicce", "Recep"],
          answer: 0
        }
      ]
    },
    de: {
      prayerTitle: "HBVC Gebetszeiten (Duisburg Hochfeld - 31. Mai 2025)",
      hadith: "Der Prophet (s.a.v) sagte: <strong>„Erleichtert und erschwert nicht; freut euch und macht keinen Hass.“</strong> (Bukhari)",
      countdownLabel: "Countdown bis zum Gebetsruf:",
      quizTitle: "Tägliches Quiz",
      countdownBtnShow: "Countdown anzeigen",
      countdownBtnHide: "Countdown ausblenden",
      prayers: [
        {name: "Fajr", time: "03:15"},
        {name: "Sonnenaufgang", time: "05:30"},
        {name: "Dhuhr", time: "13:00"},
        {name: "Asr", time: "17:00"},
        {name: "Maghrib", time: "20:15"},
        {name: "Isha", time: "22:00"}
      ],
      quiz: [
        {
          question: "Wie viele Gebetszeiten gibt es?",
          options: ["3", "5", "7", "4"],
          answer: 1
        },
        {
          question: "In welche Richtung zeigt die Qibla?",
          options: ["Norden", "Süden", "Qibla", "Westen"],
          answer: 2
        },
        {
          question: "In welchem Monat wird gefastet?",
          options: ["Ramadan", "Schawwal", "Dhul-Hijja", "Rajab"],
          answer: 0
        }
      ]
    }
  };

  // --- Global State ---
  let currentLang = 'tr';
  let countdownVisible = false;
  let countdownInterval = null;

  // --- Elementler ---
  const btnTR = document.getElementById('btnTR');
  const btnDE = document.getElementById('btnDE');
  const prayerTitle = document.getElementById('prayerTitle');
  const prayerTimesList = document.getElementById('prayerTimesList');
  const hadithEl = document.getElementById('hadith');
  const countdownEl = document.getElementById('countdown');
  const toggleCountdownBtn = document.getElementById('toggleCountdownBtn');
  const currentTimeEl = document.getElementById('current-time');

  const quizTitle = document.getElementById('quizTitle');
  const quizQuestion = document.getElementById('quizQuestion');
  const quizOptions = document.getElementById('quizOptions');
  const quizMessage = document.getElementById('quizMessage');

  // --- Fonksiyonlar ---

  function updateLanguage(lang) {
    currentLang = lang;
    const data = langData[lang];

    // Dil butonları aktiflik durumu
    btnTR.classList.toggle('active', lang === 'tr');
    btnDE.classList.toggle('active', lang === 'de');
    btnTR.setAttribute('aria-pressed', lang === 'tr');
    btnDE.setAttribute('aria-pressed', lang === 'de');

    // Başlık ve Hadis
    prayerTitle.textContent = data.prayerTitle;
    hadithEl.innerHTML = data.hadith;
    quizTitle.textContent = data.quizTitle;
    toggleCountdownBtn.textContent = countdownVisible ? data.countdownBtnHide : data.countdownBtnShow;

    // Namaz Vakitleri Listele
    renderPrayerTimes(data.prayers);

    // Quiz Hazırla
    loadQuiz();
  }

  function renderPrayerTimes(prayers) {
    prayerTimesList.innerHTML = '';
    prayers.forEach(({name, time}) => {
      const div = document.createElement('div');
      div.className = 'prayer-time';
      div.textContent = `${name}: ${time}`;
      prayerTimesList.appendChild(div);
    });
  }

  function updateCurrentTime() {
    const now = new Date();
    // Saat: 24 saat formatı, dakikalar iki basamaklı
    const hours = now.getHours().toString().padStart(2,'0');
    const minutes = now.getMinutes().toString().padStart(2,'0');
    const seconds = now.getSeconds().toString().padStart(2,'0');
    currentTimeEl.textContent = `${hours}:${minutes}:${seconds}`;
  }

  // Geri sayım için en yakın vakti bul
  function getNextPrayerTime() {
    const now = new Date();
    const prayers = langData[currentLang].prayers;
    // Vakitleri tarih objesine çevir
    const todayStr = now.toISOString().slice(0,10); // yyyy-mm-dd
    let nextPrayerDate = null;
    for (const p of prayers) {
      const [h,m] = p.time.split(':').map(Number);
      const prayerDate = new Date(`${todayStr}T${p.time}:00`);
      if (prayerDate > now) {
        nextPrayerDate = prayerDate;
        break;
      }
    }
    // Eğer bugünün vakti yoksa (örneğin gece geç saat) yarınki ilk vakti al
    if (!nextPrayerDate) {
      // Yarın için ilk vakti al
      const tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate() +1);
      const tomorrowStr = tomorrow.toISOString().slice(0,10);
      const firstPrayerTime = prayers[0].time;
      nextPrayerDate = new Date(`${tomorrowStr}T${firstPrayerTime}:00`);
    }
    return nextPrayerDate;
  }

  function updateCountdown() {
    const now = new Date();
    const nextPrayer = getNextPrayerTime();
    let diff = Math.floor((nextPrayer - now)/1000); // saniye
    if(diff < 0) diff = 0;

    const hours = Math.floor(diff / 3600);
    const minutes = Math.floor((diff % 3600) / 60);
    const seconds = diff % 60;

    const label = langData[currentLang].countdownLabel;

    countdownEl.textContent = `${label} ${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
  }

  function startCountdown() {
    if(countdownInterval) clearInterval(countdownInterval);
    countdownEl.hidden = false;
    toggleCountdownBtn.setAttribute('aria-pressed', 'true');
    toggleCountdownBtn.textContent = langData[currentLang].countdownBtnHide;
    countdownInterval = setInterval(updateCountdown, 1000);
    updateCountdown();
  }

  function stopCountdown() {
    if(countdownInterval) {
      clearInterval(countdownInterval);
      countdownInterval = null;
    }
    countdownEl.hidden = true;
    toggleCountdownBtn.setAttribute('aria-pressed', 'false');
    toggleCountdownBtn.textContent = langData[currentLang].countdownBtnShow;
  }

  function toggleCountdown() {
    countdownVisible = !countdownVisible;
    if(countdownVisible) startCountdown();
    else stopCountdown();
  }

  // --- Quiz Fonksiyonları ---

  // Günlük quiz için tarih bazlı index
  function getDailyQuizIndex() {
    const today = new Date();
    return today.getDate() % langData[currentLang].quiz.length;
  }

  function loadQuiz() {
    quizMessage.textContent = '';
    quizOptions.innerHTML = '';
    const data = langData[currentLang];
    const quizData = data.quiz[getDailyQuizIndex()];
    quizQuestion.textContent = quizData.question;

    quizData.options.forEach((opt, i) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = opt;
      btn.setAttribute('data-index', i);
      btn.addEventListener('click', () => handleQuizAnswer(i, quizData.answer));
      quizOptions.appendChild(document.createElement('li')).appendChild(btn);
    });
  }

  function handleQuizAnswer(selectedIndex, correctIndex) {
    const buttons = quizOptions.querySelectorAll('button');
    quizMessage.textContent = '';
    buttons.forEach((btn, i) => {
      btn.disabled = true;
      if(i === correctIndex) {
        btn.classList.add('correct');
      } else if(i === selectedIndex) {
        btn.classList.add('incorrect');
      }
    });
    if(selectedIndex === correctIndex) {
      quizMessage.textContent = currentLang === 'tr' ? "Tebrikler, doğru cevap!" : "Glückwunsch, richtige Antwort!";
    } else {
      quizMessage.textContent = currentLang === 'tr' ? "Maalesef, yanlış cevap." : "Leider falsch.";
    }
  }

  // --- Dil Seçici Eventleri ---
  btnTR.addEventListener('click', () => {
    if(currentLang !== 'tr') updateLanguage('tr');
  });
  btnDE.addEventListener('click', () => {
    if(currentLang !== 'de') updateLanguage('de');
  });

  // --- Buton Eventleri ---
  toggleCountdownBtn.addEventListener('click', toggleCountdown);

  // --- Sayfa yüklenince ---
  function init() {
    updateLanguage(currentLang);
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
  }

  init();

})();
</script>
